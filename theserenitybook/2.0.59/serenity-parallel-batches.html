<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Serenity tests in parallel batches :: The Serenity BDD Book</title>
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">The Serenity BDD Book</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <a class="navbar-item" href="https://github.com/serenity-bdd/serenity-core/issues">Issues</a>
        <a class="navbar-item" href="https://github.com/serenity-bdd/serenity-core">Source Code on Github</a>
        <a class="navbar-item" href="https://johnfergusonsmart.com/serenity-bdd-mentoring/">Serenity Support</a>
        <a class="navbar-item" href="https://serenitydojo.teachable.com">Serenity Online Training</a>

        <!-- <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div> -->
        <!-- <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div> -->
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="theserenitybook" data-version="2.0.59">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">The Serenity Book</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Serenity BDD Fundamentals</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction to Serenity BDD</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting-started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="first-steps.html">First Steps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-libraries.html">Working with Step Libraries</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Testing Web Applications</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="web-testing-in-serenity.html">Testing Web Applications</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="page-objects.html">Working with Page Objects</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="angularjs.html">Testing AngularJS applications</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="remote.html">Running Remote Tests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="extending-webdriver.html">Extending Webdriver setup and teardown</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Serenity with JUnit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="junit-basic.html">Basic JUnit Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="junit.html">JUnit WebDriver Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="junit-skipping.html">Skipping Tests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="junit-data-driven.html">Data Driven Tests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="junit-requirements.html">Modelling JUnit Requirements</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Serenity with BDD Frameworks</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="jbehave.html">Working with JBehave</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cucumber.html">Working with Cucumber JVM</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Working with REST APIs</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serenity-rest.html">REST API Testing in Serenity</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Serenity and the Screenplay Pattern</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serenity-screenplay.html">Screenplay Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="screenplay-selenium-tasks.html">Web Testing with Screenplay</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serenity-screenplay-rest.html">REST API Testing with Screenplay</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serenity-screenplay-ensure.html">Fluent Assertions in Screenplay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Reporting and Living documentation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="living-documentation.html">Living Documentation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="filtering-reports.html">Filtering Reports</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="extended-reports.html">Additional Reports</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="manual-tests.html">Reporting Manual Test Results</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="jira.html">Integrating with JIRA</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Scaling Serenity</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serenity-parallel.html">Running Serenity tests in parallel on a local machine</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="serenity-grid.html">Running Serenity tests on a Selenium Grid</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="serenity-parallel-batches.html">Running Serenity tests in parallel batches</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="glossary.adoc">Glossary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">The Serenity Book</span>
    <span class="version">2.0.59</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">The Serenity Book</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">2.0.59</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">The Serenity Book</a></li>
    <li class="crumb">Scaling Serenity</li>
    <li class="crumb"><a href="serenity-parallel-batches.html">Running Serenity tests in parallel batches</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/serenity-bdd/the-serenity-book/edit/master/modules/ROOT/pages/serenity-parallel-batches.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Running Serenity tests in parallel batches</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes projects have a lot of tests, and executing of them takes a lot of time. Testing can be sped up significantly by running different tests in parallel. However, this is often harder to implement than it sounds.</p>
</div>
<div class="paragraph">
<p>Some build automation tools have builtin parallel test execution, but this not so good for huge amount of tests and heavy tests. For example web tests are as a rule much slower than other types of tests, it make them good candidates for concurrent testing, in theory at least, but the implementation can be tricky. For example, although it is easy enough to configure running tests in parallel, on the other hand running several webdriver instances of Firefox/Chrome in parallel on the same display, tends to become unreliable.</p>
</div>
<div class="paragraph">
<p>The natural solution in this case is to split the web tests into smaller batches, and to run each batch on a different machine and/or on a different virtual display. When each batch has finished, the results can be retrieved and aggregated into the final test reports.</p>
</div>
<div class="paragraph">
<p>However splitting tests into manually batches by hand tends to be tedious and unreliable – it is easy to forget to add a new test to a batch, for example, or have unevenly-distributed batches.</p>
</div>
<div class="paragraph">
<p>Serenity provides mechanisms to automatically split your test suite into slices at runtime, removing the need for any manual structuring of source files or maintenance of scripts. In practice, you decide on the number of batches you require, then run a job associated with each batch number which will deterministically run only tests that belong to that batch. When all jobs have completed running, the test result output is aggregated into the final serenity test report.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_splitting_a_serenity_suite_into_batches"><a class="anchor" href="#_splitting_a_serenity_suite_into_batches"></a>Splitting a Serenity suite into batches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following parameters affect Serenity&#8217;s batching behaviour and can be provided at runtime as system parameters or be added to a serenity.properties or serenity.conf file:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>serenity.batch.count</strong></dt>
<dd>
<p>Refers to the total number of separately/concurrently running jobs that the whole test suite will be divided up into at runtime. So for instance if you had 8 build slaves available to run your tests, you would set this property to 8. This value would be the same for all jobs running each batch, The property needs to be greater than 1 in order for serenity to trigger its batching behaviour.</p>
</dd>
<dt class="hdlist1"><strong>serenity.batch.number</strong></dt>
<dd>
<p>This parameter should be different for each batch, and should be a value between 1 and <code>serenity.batch.count</code>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_junit_specific_configuration"><a class="anchor" href="#_junit_specific_configuration"></a>JUnit-specific configuration</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>serenity.batch.strategy</strong></dt>
<dd>
<p>Optional parameter for choosing batch weighting strategy (Junit tests only). Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p><code>DIVIDE_EQUALLY</code>: Test classes are allocated to batches on a 'round-robin' basis without regard for the number of test methods in each class.
So for example if <code>serenity.batch.count</code> is 3 and we have classes <code>T1, T2, T3, T4, T5</code>, the first batch will contain <code>T1, T4,</code> the second will contain <code>T2, T5</code>, and the third will contain <code>T3</code>.
<code>DIVIDE_EQUALLY</code> is the default behaviour when no batch strategy parameter is explicitly set.</p>
</li>
<li>
<p><code>DIVIDE_BY_TEST_COUNT</code>. Classes are allocated to batches based on the number of test methods they contain.
So for example if <code>serenity.batch.count</code> is 2 and class <code>T1</code> contains 4 tests, <code>T2</code> contains 2 tests, <code>T3</code> contains 2 tests, both batches will contain 4 tests each, the first batch containing  <code>T1</code>, and the second one containing <code>T3</code> and <code>T2</code>.
<code>DIVIDE_BY_TEST_COUNT</code> tends to provide more evenly balanced batches than <code>DIVIDE_EQUALLY</code>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cucumber_specific_configuration"><a class="anchor" href="#_cucumber_specific_configuration"></a>Cucumber-specific configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Batching a Cucumber test suite requires a different approach to that used in the JUnit implementation as there is often only a single test runner class used to run the entire suite, so the work cannot be split at the class or test method level.
However, no changes are required to an existing test runner infrastructure, so test runner classes annotated with <code>@RunWith(CucumberWithSerenity.class)</code> can still be configured for parallel execution.
Serenity achieves Cucumber test suite batching by analysing the features that are about to be run and splitting the contained scenarios based on their 'weight'.
Serenity calculates scenario 'weight' into <code>TestStatistics</code> based on one of the following algorithms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ScenarioLineCountStatistics</code>: the number of steps in each scenario (default).</p>
</li>
<li>
<p><code>MultiRunTestStatistics</code>: the historic duration of each scenario when it was run in your CI environment (using one or more Serenity results.csv files).
This algorithm provides the potential for very accurate slicing, ensuring that all parallel batches have equal run-times and all complete at virtually the same time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following parameters can be used to configure Serenity&#8217;s Cucumber batching behaviour:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>serenity.test.statistics.dir</strong></dt>
<dd>
<p>This parameter provides a relative path to the location where one or more serenity results CSV files can be found, taken from recent builds. Any number of results files can be placed in this location and serenity will calculate an averaged scenario weighting.
For instance if you created a directory called <code>src/test/resources/aggregated</code> on the file system, the supplied parameter would be <code>/aggregated</code>.
Note that if this parameter is omitted, the <code>ScenarioLineCountStatistics</code> algorithm will automatically be selected, however if it is supplied, then the path must exist or a runtime exception will be thrown.</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="_subdividing_a_cucumber_batches_within_a_machine"><a class="anchor" href="#_subdividing_a_cucumber_batches_within_a_machine"></a>Subdividing a Cucumber batches within a machine</h3>
<div class="paragraph">
<p>If your build slaves are capable of reliably running tests on more than one browser concurrently, batching can be taken a step further
and scenarios can be divided amongst multiple forked processes. Conceptually, a batch is allocated to machine by means of the <code>serenity.batch.count</code> and <code>serenity.batch.number</code> parameters described above,
but then the following parameters are used to further subdivide this batch across local forked processes on the build slave:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>serenity.fork.count</strong></dt>
<dd>
<p>Refers to the total number of forks that will be created on the build slave. So for instance if you could reliably start 4 browsers on one of your build slaves, you would set this property to 4. This value would be the same for all jobs running each batch, The property needs to be greater than 1 in order for serenity to trigger its batching behaviour.</p>
</dd>
<dt class="hdlist1"><strong>serenity.fork.number</strong></dt>
<dd>
<p>This parameter will be different for each forked process and will be set automatically by the test runner when it creates the forked processes. It will be a value between 1 and <code>serenity.batch.count</code>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_and_running_batched_cucumber_test_suites_from_maven"><a class="anchor" href="#_configuring_and_running_batched_cucumber_test_suites_from_maven"></a>Configuring and running batched Cucumber test suites from Maven</h3>
<div class="paragraph">
<p>This section is easier to understand by means of a reference to a working example which can be found in the <a href="https://github.com/serenity-bdd/serenity-cucumber">serenity-cucumber</a> project.
In this, the <a href="https://github.com/serenity-bdd/serenity-cucumber/tree/master/src/smoketests">smoke tests</a> module has been augmented to demonstrate Cucumber batching.
All example commands should be executed after moving to the <code>src/smoketests</code> direct from the root of the project.</p>
</div>
<div class="sect3">
<h4 id="_configuring_test_runners"><a class="anchor" href="#_configuring_test_runners"></a>Configuring test runners</h4>
<div class="paragraph">
<p>A test runner should be configured in such a way to include all features and scenarios that you wish to slit up into batches/forks. In our example, <code>SlicedTestRunner.java</code> has already been created as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>@RunWith(CucumberWithSerenity.class)
@CucumberOptions(glue = "smoketests.stepdefinitions", features = "classpath:features")
public class SlicedTestRunner {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wish to subdivide Cucumber batches within a machine by forking, identical copies of the test runner will need to be created in the same location that add up the maximm number of forks.
In the <a href="https://github.com/serenity-bdd/serenity-cucumber/tree/master/src/smoketests/src/test/java/smoketests">smoke tests module</a>, the classes <code>SlicedTestRunner2</code>, <code>SlicedTestRunner3</code>, <code>SlicedTestRunner4</code> have been created in addition to <code>SlicedTestRunner.java</code> for this purpose.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_pom_xml"><a class="anchor" href="#_configuring_pom_xml"></a>Configuring pom.xml</h4>
<div class="paragraph">
<p>The <code>pom.xml</code> for this project has <code>4</code> <code>&lt;parallel.tests&gt;</code> defined within the <code>&lt;properties&gt;</code> section as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;properties&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;serenity.version&gt;1.9.37&lt;/serenity.version&gt;
    &lt;serenity.maven.version&gt;1.9.6&lt;/serenity.maven.version&gt;
    &lt;serenity.cucumber.version&gt;1.9.16-SNAPSHOT&lt;/serenity.cucumber.version&gt;
    &lt;encoding&gt;UTF-8&lt;/encoding&gt;
    &lt;parallel.tests&gt;4&lt;/parallel.tests&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that when the tests are executed, up to 4 browsers will potentially be started simultaneously.</p>
</div>
<div class="paragraph">
<p>In the <code>maven-failsafe-plugin</code> section, the <code>&lt;parallel.tests&gt;</code> property is referenced in the <code>&lt;threadCount&gt;</code> and <code>&lt;forkCount&gt;</code> nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;plugin&gt;
    &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.22.0&lt;/version&gt;
    &lt;configuration&gt;
        &lt;includes&gt;
            &lt;include&gt;**/When*.java&lt;/include&gt;
        &lt;/includes&gt;
        &lt;systemPropertyVariables&gt;
            &lt;webdriver.base.url&gt;${webdriver.base.url}&lt;/webdriver.base.url&gt;
        &lt;/systemPropertyVariables&gt;
        &lt;parallel&gt;classes&lt;/parallel&gt;
        &lt;threadCount&gt;${parallel.tests}&lt;/threadCount&gt;
        &lt;forkCount&gt;${parallel.tests}&lt;/forkCount&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;integration-test&lt;/goal&gt;
                &lt;goal&gt;verify&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to allow the suite to be run in both forked and an non-forked configurations, two profiles have been defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;profile&gt;
    &lt;id&gt;dontUseTheForks&lt;/id&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.20&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;includes&gt;
                        &lt;include&gt;**/SlicedTestRunner.java&lt;/include&gt;
                    &lt;/includes&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/profile&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above profile:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The name <code>dontUseTheForks</code> has been assigned.</p>
</li>
<li>
<p>The wildcard <code>**/SlicedTestRunner.java</code> referenced in the <code>&lt;include&gt;</code> node of the <code>&lt;includes&gt;</code> section of <code>&lt;configuration&gt;</code> will only include a single test runner.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;profile&gt;
    &lt;id&gt;useTheForks&lt;/id&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.20&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;includes&gt;
                        &lt;include&gt;**/SlicedTestRunner*.java&lt;/include&gt;
                    &lt;/includes&gt;
                    &lt;systemPropertyVariables&gt;
                        &lt;serenity.fork.count&gt;0${parallel.tests}&lt;/serenity.fork.count&gt;
                        &lt;serenity.fork.number&gt;0${surefire.forkNumber}&lt;/serenity.fork.number&gt;
                    &lt;/systemPropertyVariables&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/profile&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above profile:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The name <code>useTheForks</code> has been assigned.</p>
</li>
<li>
<p><code>&lt;serenity.fork.count&gt;</code> is set to the value of <code>${parallel.tests}</code>.</p>
</li>
<li>
<p><code>&lt;serenity.fork.number&gt;</code> is set to the value of <code>${surefire.forkNumber}</code>. This is automatically set by maven at runtime and will be a value from 1 to <code>${parallel.tests}</code>.</p>
</li>
<li>
<p>Note that both of the above two properties need to be prefixed by <code>0</code>, in order for <a href="https://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html">maven property expansion</a> to return a value, rather than null.</p>
</li>
<li>
<p>The wildcard <code>**/SlicedTestRunner *.java</code> referenced in the <code>&lt;include&gt;</code> node of the <code>&lt;includes&gt;</code> section of <code>&lt;configuration&gt;</code> will include all 4 test runner classes, one for each forked process.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_automatic_tagging_to_the_serenity_html_report"><a class="anchor" href="#_adding_automatic_tagging_to_the_serenity_html_report"></a>Adding automatic tagging to the Serenity HTML report</h3>
<div class="paragraph">
<p>Tags can be automatically be added to the HTML report which show the batch and the fork that each scenario was allocated to. This is really useful for showing how successful the slicing algorithm has been on your test suite.
To make this work, add a hook into the package referred to in the test runner <code>glue</code> settings as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>package smoketests.stepdefinitions;

import cucumber.api.java.Before;
import net.serenitybdd.cucumber.suiteslicing.SerenityTags;

public class Hooks {

    @Before
    public void before() {
        SerenityTags.create().tagScenarioWithBatchingInfo();
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_tests_from_maven"><a class="anchor" href="#_running_tests_from_maven"></a>Running tests from Maven</h3>
<div class="sect3">
<h4 id="_non_forked_execution"><a class="anchor" href="#_non_forked_execution"></a>Non-forked execution</h4>
<div class="paragraph">
<p>To run smoke tests without forking, use the command:</p>
</div>
<div class="paragraph">
<p><code>mvn clean verify -P dontUseTheForks</code></p>
</div>
<div class="paragraph">
<p>You should see a single browser window open to run the suite. When it completes, if you view the html report in serenity-cucumber/src/smoketests/target/site/serenity/index.html,
you should see that 41 tests have been run:</p>
</div>
<div id="fig-cucumber-batching-webtests-summary" class="imageblock">
<div class="content">
<img src="_images/cucumber-batching-webtests-summary.png" alt="cucumber batching webtests summary" width="700">
</div>
<div class="title">Figure 1. Summary report statistics</div>
</div>
</div>
<div class="sect3">
<h4 id="_forked_execution_line_count_statistics"><a class="anchor" href="#_forked_execution_line_count_statistics"></a>Forked execution (line count statistics)</h4>
<div class="paragraph">
<p>To run smoke tests with forking based on <code>ScenarioLineCountStatistics</code>, use the command:</p>
</div>
<div class="paragraph">
<p><code>mvn clean verify -Dserenity.batch.count=1 -Dserenity.batch.number=1 -P useTheForks</code></p>
</div>
<div class="paragraph">
<p>You should see multiple browser windows open to run the suite. When it completes, if you view the html report you should see the following at the bottom of the Related Tags section:</p>
</div>
<div id="fig-cucumber-batching-with-line-count-stats" class="imageblock">
<div class="content">
<img src="_images/cucumber-batching-with-line-count-stats.png" alt="cucumber batching with line count stats" width="700">
</div>
<div class="title">Figure 2. Test batches and forks tagging using line count stats</div>
</div>
<div class="paragraph">
<p>This shows that the 41 scenarios were reasonably equally spread across the 4 forks based on the number of scenarios.
The execution time for each fork will not necessarily be equal however, as some scenarios will take longer than others.</p>
</div>
</div>
<div class="sect3">
<h4 id="_forked_execution_multi_run_statistics"><a class="anchor" href="#_forked_execution_multi_run_statistics"></a>Forked execution (multi-run statistics)</h4>
<div class="paragraph">
<p>In order to provide the most finely balanced test slicing, "run statistics" from previous run(s) of the suite can be passed to the maven command using the parameter <code>serenity.test.statistics.dir</code>.</p>
</div>
<div class="paragraph">
<p>In the smoke tests project, two example files have been added to demonstrate this capability:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>statistics/results-run-1.csv</p>
</li>
<li>
<p>statistics/results-run-2.csv</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To run smoke tests with forking based on <code>MultiRunTestStatistics</code>, use the command:</p>
</div>
<div class="paragraph">
<p><code>mvn clean verify -Dserenity.batch.count=1 -Dserenity.batch.number=1 -Dserenity.test.statistics.dir=/statistics -P useTheForks</code></p>
</div>
<div class="paragraph">
<p>Again, you should see multiple browser windows open to run the suite. When it completes, if you view the html report you should see the following at the bottom of the Related Tags section:</p>
</div>
<div id="fig-cucumber-batching-with-multi-run-stats" class="imageblock">
<div class="content">
<img src="_images/cucumber-batching-with-multi-run-stats.png" alt="cucumber batching with multi run stats" width="700">
</div>
<div class="title">Figure 3. Test batches and forks tagging using multi-run stats</div>
</div>
<div class="paragraph">
<p>This shows that now the 41 scenarios are allocated to each fork very differently - based on the sum total of durations in each scenario.
You can verify this by clicking on links associated with Fork 1, 2, 3, or 4 and you should see that the execution times are much more evenly balanced than in the previous example.
This allocation gets even more 'smoother' for test suites with a larger number of scenarios than the smoke tests example project.</p>
</div>
</div>
<div class="sect3">
<h4 id="_combining_batching_and_forking"><a class="anchor" href="#_combining_batching_and_forking"></a>Combining batching and forking</h4>
<div class="paragraph">
<p>This is simply a matter of combining the previously described <code>pom.xml</code> configuration with the correct batch parameters.
So, for example instance if you have 3 build slaves available to run your tests each of which could run 4 forks, you would set <code>${parallel.tests}</code> to <code>4</code> on the project pom, then run the following commands:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>slave 1: <code>mvn clean verify -Dserenity.batch.count=3 -Dserenity.batch.number=1 -P useTheForks</code></p>
</li>
<li>
<p>slave 2: <code>mvn clean verify -Dserenity.batch.count=3 -Dserenity.batch.number=2 -P useTheForks</code></p>
</li>
<li>
<p>slave 3: <code>mvn clean verify -Dserenity.batch.count=3 -Dserenity.batch.number=3 -P useTheForks</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then a total of 12 browser sessions would be created during the test execution.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_parallel_batch_execution_with_jenkins_1"><a class="anchor" href="#_configuring_parallel_batch_execution_with_jenkins_1"></a>Configuring parallel batch execution with Jenkins 1</h3>
<div class="paragraph">
<p>This approach is easy to set up on Jenkins using a multi-configuration build. In the following screenshot, we are running a multi-configuration build to run web tests across three batches. We use a single user-defined parameter (BATCH_NUMBER) to define the batch being run, passing this parameter into the Maven build job properties we discussed above.</p>
</div>
<div id="fig-multi-configuration-build" class="imageblock">
<div class="content">
<img src="_images/parallel-webtests-matrix-build.png" alt="parallel webtests matrix build">
</div>
<div class="title">Figure 4. Multi-configuration build to run web tests across three batches</div>
</div>
<div class="paragraph">
<p>The most robust way to aggregate the build results from the different batches is to set up a second build job that runs after the test executions, and retrieves the build results from the batch jobs. You can use the Jenkins Copy Artifacts plugin to do this. First, ensure that the multi-configuration build archives the Serenity reports, as shown here:</p>
</div>
<div id="fig-achieving-serenity-reports" class="imageblock">
<div class="content">
<img src="_images/parallel-webtests-post-build.png" alt="parallel webtests post build">
</div>
<div class="title">Figure 5. Configuration archiving the Serenity reports</div>
</div>
<div class="paragraph">
<p>This build will then trigger another, freestyle build job. This job needs to copy the Serenity report artifacts from the matrix build jobs into the current workspace, and then run the mvn serenity:aggregate command to generate the Serenity aggregate reports. The matrix build job reports need to be copied one-by-one for each batch, as the current version of the Copy Artifacts plugin does not support copying from multiple projects in the same action.</p>
</div>
<div id="fig-copying-the-serenity-report-artifacts" class="imageblock">
<div class="content">
<img src="_images/parallel-webtests-aggregate.png" alt="parallel webtests aggregate">
</div>
<div class="title">Figure 6. Configuration copying the Serenity report artifacts and aggregating reports</div>
</div>
<div class="paragraph">
<p>Then make sure you publish the generated HTML reports (which will be in the target/site/serenity directory) for easy access to the test results.</p>
</div>
<div class="paragraph">
<p>This simple example shows a parallel test running 3 batches – this brought the test execution time from 9 minutes to slightly over 1 minute. Results will vary, of course, but a typical real-world set of web tests would have a larger number of batches</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_parallel_batch_execution_with_jenkins_2_dsl"><a class="anchor" href="#_configuring_parallel_batch_execution_with_jenkins_2_dsl"></a>Configuring parallel batch execution with Jenkins 2 (DSL)</h3>
<div class="paragraph">
<p>If your CI infrastructure runs on <a href="https://jenkins.io/2.0">Jenkins 2</a> that has the
<a href="https://wiki.jenkins-ci.org/display/JENKINS/Pipeline+Plugin">Pipeline</a> and <a href="https://wiki.jenkins-ci.org/display/JENKINS/HTML+Publisher+Plugin">HTML Publisher</a> plugins installed,
you can quickly define parallel pipelines via a JenkinsFile.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int BATCH_COUNT = 8
int FORK_COUNT = 8
def serenityBatches = [:]

for (int i = 1; i &lt;= BATCH_COUNT; i++) {
    def batchNumber = i
    def batchName = "batch-${batchNumber}"

    serenityBatches[batchName] = {
        node {
            checkout scm
            try {
                mvn "clean"
                sh "rm -rf target/site/serenity"
                mvn "verify -Dit.test=MyTestRunner* -Dparallel.tests=FORK_COUNT -Dserenity.batch.count=${BATCH_COUNT} -Dserenity.batch.number=${batchNumber} -Dserenity.test.statistics.dir=/statistics -f businessAcceptanceTests/pom.xml"
            } catch (Throwable e) {
                throw e
            } finally {
                stash name: batchName,
                    includes: "target/site/serenity/**/*",
                    allowEmpty: true
            }
        }
    }
}

stage("automated tests") {
    parallel serenityBatches
}

stage("report aggregation") {
    node {
        // unstash each of the batches

        for (batchNumber in BATCH_COUNT) {
            def batchName = "batch-${batchNumber}"
            echo "Unstashing serenity reports for ${batchName}"
            unstash batchName
        }

        // publish the Serenity report

        publishHTML(target: [
                reportName : 'Serenity',
                reportDir:   'target/site/serenity',
                reportFiles: 'index.html',
                keepAll:     true,
                alwaysLinkToLastBuild: true,
                allowMissing: false
        ])
    }
}</pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
